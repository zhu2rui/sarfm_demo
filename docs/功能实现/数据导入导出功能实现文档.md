# 数据导入导出功能实现文档

## 1. 功能概述

本功能为实验室库存管理系统添加了数据导入与导出功能，支持以下操作：

- **数据导出**：将表格中所有可见字段和当前筛选条件下的完整数据导出为CSV格式文件
- **数据导入**：通过上传CSV格式文件批量导入数据，要求导入文件的表头与系统表格字段严格对应

## 2. 实现细节

### 2.1 数据导出功能

#### 2.1.1 前端实现
- **组件**：`DataManagement.jsx`
- **功能入口**：数据管理页面操作栏的"导出CSV"按钮
- **核心函数**：`handleExport`
  - 获取当前表格的所有可见列
  - 调用API获取所有数据（不考虑分页）
  - 构建CSV格式内容
  - 创建下载链接，触发浏览器下载
- **导出文件命名规则**：`{表格名称}.csv`

#### 2.1.2 后端实现
- **API端点**：`GET /api/v1/tables/{table_id}/data`
- **功能**：获取表格数据，支持分页参数
- **返回数据格式**：JSON格式，包含数据列表、总数等信息

### 2.2 数据导入功能

#### 2.2.1 前端实现
- **组件**：`DataManagement.jsx`
- **功能入口**：数据管理页面操作栏的"导入数据"按钮
- **导入流程**：
  1. 点击"导入数据"按钮，打开导入模态框
  2. 选择CSV文件
  3. 系统验证文件格式和表头匹配性
  4. 验证通过后，点击"导入数据"按钮
  5. 系统调用API批量导入数据
  6. 显示导入结果
- **核心函数**：`handleImport`
  - 读取CSV文件内容
  - 解析CSV数据
  - 验证表头匹配性
  - 批量导入数据
  - 显示导入结果

#### 2.2.2 后端实现
- **API端点**：`POST /api/v1/tables/{table_id}/data/batch`
- **功能**：批量添加库存数据
- **请求数据格式**：JSON格式，包含数据列表
- **返回数据格式**：JSON格式，包含成功数量、失败数量、失败原因等信息

## 3. 使用方法

### 3.1 数据导出

1. 登录系统，进入数据管理页面
2. 在左侧菜单的"数据管理"分类下，选择要导出数据的表格
3. 在右侧数据展示区域的操作栏中，点击"导出CSV"按钮
4. 系统会自动生成并下载CSV格式文件

### 3.2 数据导入

1. 登录系统，进入数据管理页面
2. 在左侧菜单的"数据管理"分类下，选择要导入数据的表格
3. 在右侧数据展示区域的操作栏中，点击"导入数据"按钮
4. 在弹出的模态框中，点击"选择CSV文件"按钮，选择要导入的CSV文件
5. 系统会自动验证文件格式和表头匹配性
   - 若格式不正确，会显示错误提示
   - 若表头不匹配，会显示详细的匹配结果
6. 验证通过后，点击"导入数据"按钮
7. 系统会批量导入数据，并显示导入结果
   - 成功导入的数据量
   - 失败的数据量及失败原因（如有）

## 4. 注意事项

### 4.1 数据导出注意事项

1. 导出的数据仅包含表格中所有可见字段
2. 导出的数据包含当前筛选条件下的完整数据
3. 导出文件格式为CSV，使用UTF-8编码
4. 导出过程中，系统会显示加载状态，请勿频繁点击导出按钮
5. 若数据量较大，导出过程可能需要较长时间，请耐心等待

### 4.2 数据导入注意事项

1. 导入文件必须为CSV格式，使用UTF-8编码
2. 导入文件的表头必须与系统表格字段严格对应，包括顺序和名称
3. 导入文件的内容必须符合系统表格字段的数据类型要求
4. 导入过程中，系统会显示加载状态，请勿频繁点击导入按钮
5. 若数据量较大，导入过程可能需要较长时间，请耐心等待
6. 导入数据时，系统会自动验证每条数据的格式，格式错误的数据会被跳过
7. 只有管理员和组长角色可以执行数据导入操作

## 5. 技术文档

### 5.1 前端核心代码

#### 5.1.1 导出功能核心代码
```javascript
const handleExport = async () => {
  // 获取所有数据（不考虑分页）
  const response = await axios.get(`/api/v1/tables/${selectedTable.id}/data`, {
    params: { page: 1, per_page: total }
  })
  
  // 构建CSV内容
  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
  ].join('\n')
  
  // 创建下载链接
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.setAttribute('download', `${selectedTable.table_name}.csv`)
  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)
}
```

#### 5.1.2 导入功能核心代码
```javascript
const handleImport = async () => {
  // 读取文件内容
  const reader = new FileReader()
  reader.readAsText(importFile.originFileObj)
  
  reader.onload = async (e) => {
    const csvContent = e.target.result
    
    // 解析CSV数据
    const lines = csvContent.split('\n').filter(line => line.trim() !== '')
    
    // 提取表头并验证匹配性
    const headers = lines[0].split(',').map(header => header.replace(/"/g, '').trim())
    const isMatch = JSON.stringify(headers) === JSON.stringify(tableHeaders)
    
    if (!isMatch) {
      message.error('CSV文件表头与表格字段不匹配，请检查文件格式')
      return
    }
    
    // 解析数据行并批量导入
    const dataRows = lines.slice(1).map(line => {
      const values = line.split(',').map(value => value.replace(/"/g, '').trim())
      const rowData = {}
      visibleColumns.forEach((column, index) => {
        rowData[column.column_name] = values[index + 1] // 跳过创建时间列
      })
      return { data: rowData }
    })
    
    // 调用API批量导入数据
    const response = await axios.post(`/api/v1/tables/${selectedTable.id}/data/batch`, {
      items: dataRows
    })
  }
}
```

### 5.2 后端核心代码

#### 5.2.1 批量导入API核心代码
```python
@app.route('/api/v1/tables/<int:table_id>/data/batch', methods=['POST'])
@token_required
def batch_add_inventory_data(current_user, table_id):
    # 检查权限和数据格式
    # 批量添加数据
    success_count = 0
    error_count = 0
    error_messages = []
    
    try:
        for item in items:
            # 验证数据格式
            # 添加数据到数据库
            success_count += 1
    except Exception as e:
        error_count += 1
        error_messages.append(f'添加数据失败: {str(e)}')
    
    # 提交事务
    db.session.commit()
    
    # 返回结果
    return jsonify({
        'code': 200,
        'message': f'批量添加成功，成功{success_count}条，失败{error_count}条',
        'data': {
            'success_count': success_count,
            'error_count': error_count,
            'error_messages': error_messages
        }
    }), 200
```

## 6. 测试用例

### 6.1 数据导出测试用例

| 测试编号 | 测试场景 | 预期结果 |
|---------|---------|---------|
| 1 | 导出空表格 | 导出空CSV文件，仅包含表头 |
| 2 | 导出包含数据的表格 | 导出CSV文件，包含所有数据行 |
| 3 | 导出包含隐藏列的表格 | 导出CSV文件，仅包含可见列数据 |
| 4 | 多次点击导出按钮 | 每次点击都能正确导出文件 |

### 6.2 数据导入测试用例

| 测试编号 | 测试场景 | 预期结果 |
|---------|---------|---------|
| 1 | 导入格式不正确的文件 | 显示错误提示 |
| 2 | 导入表头不匹配的文件 | 显示表头匹配结果，提示不匹配 |
| 3 | 导入正确格式的文件 | 成功导入数据，显示导入结果 |
| 4 | 导入包含错误数据的文件 | 成功导入正确数据，跳过错误数据 |
| 5 | 多次点击导入按钮 | 每次点击都能正确执行导入操作 |

## 7. 后续优化建议

1. **支持更多文件格式**：如Excel、JSON等
2. **添加数据模板下载功能**：提供符合格式要求的CSV模板文件下载
3. **优化大数据量处理**：支持分片上传和导入，避免浏览器崩溃
4. **添加导入预览功能**：在导入前预览数据，允许用户确认和修改
5. **支持导入历史记录**：记录导入操作，方便追溯
6. **添加数据导出筛选条件**：支持根据筛选条件导出数据

## 8. 相关文件列表

| 文件路径 | 功能描述 |
|---------|---------|
| `frontend/src/pages/DataManagement.jsx` | 数据管理页面，包含导入导出功能 |
| `backend/app.py` | 后端API，包含批量导入数据功能 |
| `docs/功能实现/数据导入导出功能实现文档.md` | 功能实现文档 |

## 9. 联系人

如有问题，请联系开发团队：
- 姓名：XXX
- 邮箱：XXX
- 电话：XXX

## 10. 更新记录

| 日期 | 版本 | 更新内容 | 作者 |
|------|------|---------|------|
| 2025-12-06 | v1.0 | 初始版本，实现数据导入导出功能 | XXX |
