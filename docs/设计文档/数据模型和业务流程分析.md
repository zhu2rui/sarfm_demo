# 实验室多端Web库存管理系统 - 数据模型和业务流程分析

## 1. 数据模型分析

### 1.1 实体关系图（ER图）

```
┌─────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   Users     │       │ TableStructures │       │ InventoryData   │
├─────────────┤       ├─────────────────┤       ├─────────────────┤
│ id          │<──────┤ id              │<──────┤ id              │
│ username    │       │ table_name      │       │ table_id        │
│ password    │       │ columns         │       │ data            │
│ role        │       │ created_at      │       │ created_by      │
│ created_at  │       │ updated_at      │       │ created_at      │
│ updated_at  │       └─────────────────┘       │ updated_at      │
└─────────────┘                                 └─────────────────┘
        │                                               ▲
        │                                               │
        ▼                                               │
┌───────────────┐                                       │
│ OperationLogs │───────────────────────────────────────┘
├───────────────┤
│ id            │
│ user_id       │
│ operation     │
│ table_id      │
│ data_id       │
│ created_at    │
└───────────────┘
```

### 1.2 数据模型详细定义

#### 1.2.1 用户信息表（users）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INTEGER | - | PRIMARY KEY, AUTOINCREMENT | 用户ID，主键 |
| username | VARCHAR | 50 | UNIQUE, NOT NULL | 用户名 |
| password | VARCHAR | 255 | NOT NULL | 密码（加密存储） |
| role | VARCHAR | 20 | NOT NULL | 用户角色（admin/leader/member） |
| created_at | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**数据示例**：
```json
{
  "id": 1,
  "username": "admin",
  "password": "$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW",
  "role": "admin",
  "created_at": "2025-12-06 10:00:00",
  "updated_at": "2025-12-06 10:00:00"
}
```

#### 1.2.2 表格结构表（table_structures）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INTEGER | - | PRIMARY KEY, AUTOINCREMENT | 表格结构ID，主键 |
| table_name | VARCHAR | 255 | NOT NULL | 总表名 |
| columns | TEXT | - | NOT NULL | 列定义JSON字符串，格式：[{"column_name": "列名", "data_type": "数据类型"}...] |
| created_at | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**数据示例**：
```json
{
  "id": 1,
  "table_name": "引物库存表",
  "columns": "[{\"column_name\": \"时间\", \"data_type\": \"string\"}, {\"column_name\": \"姓名\", \"data_type\": \"string\"}, {\"column_name\": \"引物名称\", \"data_type\": \"string\"}, {\"column_name\": \"数量\", \"data_type\": \"string\"}, {\"column_name\": \"位置\", \"data_type\": \"string\"}]",
  "created_at": "2025-12-06 10:30:00",
  "updated_at": "2025-12-06 10:30:00"
}
```

#### 1.2.3 库存数据表（inventory_data）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INTEGER | - | PRIMARY KEY, AUTOINCREMENT | 数据ID，主键 |
| table_id | INTEGER | - | FOREIGN KEY REFERENCES table_structures(id), NOT NULL | 所属表格ID，外键关联table_structures.id |
| data | TEXT | - | NOT NULL | 库存数据JSON字符串，格式：{"列名1": "值1", "列名2": "值2", ...} |
| created_by | INTEGER | - | FOREIGN KEY REFERENCES users(id), NOT NULL | 创建者ID，外键关联users.id |
| created_at | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**数据示例**：
```json
{
  "id": 1,
  "table_id": 1,
  "data": "{\"时间\": \"2025-12-06\", \"姓名\": \"张三\", \"引物名称\": \"Primer A\", \"数量\": \"100\", \"位置\": \"冰箱A-1\"}",
  "created_by": 1,
  "created_at": "2025-12-06 11:00:00",
  "updated_at": "2025-12-06 11:00:00"
}
```

#### 1.2.4 操作日志表（operation_logs）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INTEGER | - | PRIMARY KEY, AUTOINCREMENT | 日志ID，主键 |
| user_id | INTEGER | - | FOREIGN KEY REFERENCES users(id), NOT NULL | 操作用户ID，外键关联users.id |
| operation | VARCHAR | 255 | NOT NULL | 操作描述 |
| table_id | INTEGER | - | NULL | 涉及的表格ID |
| data_id | INTEGER | - | NULL | 涉及的数据ID |
| created_at | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 操作时间 |

**数据示例**：
```json
{
  "id": 1,
  "user_id": 1,
  "operation": "创建表格结构：引物库存表",
  "table_id": 1,
  "data_id": null,
  "created_at": "2025-12-06 10:30:00"
}
```

### 1.3 数据模型关系分析

1. **用户与操作日志的关系**：
   - 一个用户可以执行多个操作，生成多条操作日志
   - 一条操作日志只能属于一个用户
   - 关系类型：一对多（Users:OperationLogs = 1:N）

2. **表格结构与库存数据的关系**：
   - 一个表格结构可以包含多条库存数据
   - 一条库存数据只能属于一个表格结构
   - 关系类型：一对多（TableStructures:InventoryData = 1:N）

3. **用户与库存数据的关系**：
   - 一个用户可以创建多条库存数据
   - 一条库存数据只能由一个用户创建
   - 关系类型：一对多（Users:InventoryData = 1:N）

4. **操作日志与表格结构/库存数据的关系**：
   - 一条操作日志可以涉及一个表格结构或一条库存数据
   - 一个表格结构或一条库存数据可以被多条操作日志涉及
   - 关系类型：多对多（通过operation_logs表的table_id和data_id字段实现）

## 2. 业务流程分析

### 2.1 表格结构定义流程

**流程图**：
```
开始
  │
  ▼
管理员登录系统
  │
  ▼
进入表格定义模块
  │
  ▼
输入总表名
  │
  ▼
添加列信息（列名和数据类型）
  │
  ▼
保存表格定义
  │
  ▼
系统验证数据合法性
  │
  ├─失败─► 显示错误提示
  │       │
  │       ▼
  │       结束
  │
  └─成功─► 系统将表格定义保存到数据库
  │
  ▼
已定义表格列表更新
  │
  ▼
结束
```

**详细步骤**：
1. **管理员登录系统**：管理员输入用户名和密码，系统验证通过后进入系统主界面
2. **进入表格定义模块**：管理员在侧边栏点击"表格定义"菜单，进入表格定义模块
3. **输入总表名**：管理员在总表名输入框中输入要创建的表格名称
4. **添加列信息**：管理员点击"添加列"按钮，输入列名和选择数据类型（本系统统一使用字符串类型）
5. **保存表格定义**：管理员点击"保存表格"按钮，提交表格定义
6. **系统验证数据合法性**：系统验证总表名和列信息的完整性（总表名不能为空，至少包含一列）
7. **系统保存表格定义**：验证通过后，系统将表格定义保存到table_structures表中
8. **已定义表格列表更新**：系统更新侧边栏的已定义表格列表，显示新创建的表格

### 2.2 数据添加流程

**流程图**：
```
开始
  │
  ▼
用户登录系统
  │
  ▼
在侧边栏选择要操作的表格
  │
  ▼
点击"添加数据"按钮
  │
  ▼
系统根据表格结构生成数据表单
  │
  ▼
用户填写数据表单
  │
  ▼
提交表单
  │
  ▼
系统验证数据合法性
  │
  ├─失败─► 显示错误提示
  │       │
  │       ▼
  │       结束
  │
  └─成功─► 系统将数据保存到数据库
  │
  ▼
数据表格更新
  │
  ▼
系统记录操作日志
  │
  ▼
结束
```

**详细步骤**：
1. **用户登录系统**：用户输入用户名和密码，系统验证通过后进入系统主界面
2. **选择要操作的表格**：用户在侧边栏的已定义表格列表中选择要操作的表格
3. **点击"添加数据"按钮**：用户点击数据显示区域的"添加数据"按钮
4. **系统生成数据表单**：系统根据所选表格的结构，动态生成数据表单
5. **用户填写数据表单**：用户在数据表单中填写相应的字段值
6. **提交表单**：用户点击"提交"按钮，提交数据表单
7. **系统验证数据合法性**：系统验证数据的完整性和合法性
8. **系统保存数据**：验证通过后，系统将数据保存到inventory_data表中
9. **数据表格更新**：系统更新数据显示区域的表格，显示新添加的数据
10. **系统记录操作日志**：系统在operation_logs表中记录用户的操作

### 2.3 数据查询流程

**流程图**：
```
开始
  │
  ▼
用户登录系统
  │
  ▼
在侧边栏选择要查询的表格
  │
  ▼
系统加载表格结构和数据
  │
  ▼
系统渲染数据表格
  │
  ▼
用户使用筛选条件进行数据过滤
  │
  ▼
系统根据筛选条件更新数据显示
  │
  ▼
用户使用排序功能调整数据顺序
  │
  ▼
系统根据排序条件更新数据显示
  │
  ▼
结束
```

**详细步骤**：
1. **用户登录系统**：用户输入用户名和密码，系统验证通过后进入系统主界面
2. **选择要查询的表格**：用户在侧边栏的已定义表格列表中选择要查询的表格
3. **系统加载数据**：系统根据所选表格的ID，从数据库中加载表格结构和相应的库存数据
4. **系统渲染数据表格**：系统根据表格结构和库存数据，动态渲染数据表格
5. **用户使用筛选条件**：用户在数据过滤与搜索区输入筛选条件，如日期范围、关键词等
6. **系统更新数据显示**：系统根据用户输入的筛选条件，过滤数据并更新表格显示
7. **用户使用排序功能**：用户点击表格列标题，选择升序或降序排序
8. **系统更新数据显示**：系统根据用户选择的排序条件，调整数据顺序并更新表格显示

### 2.4 用户登录流程

**流程图**：
```
开始
  │
  ▼
用户访问系统登录页面
  │
  ▼
用户输入用户名和密码
  │
  ▼
用户点击登录按钮
  │
  ▼
系统验证用户名和密码
  │
  ├─失败─► 显示错误提示
  │       │
  │       ▼
  │       结束
  │
  └─成功─► 系统创建用户会话
  │
  ▼
系统记录登录日志
  │
  ▼
用户进入系统主界面
  │
  ▼
结束
```

**详细步骤**：
1. **用户访问登录页面**：用户在浏览器中输入系统URL，访问系统登录页面
2. **用户输入登录信息**：用户在登录表单中输入用户名和密码
3. **用户点击登录按钮**：用户点击"登录"按钮，提交登录表单
4. **系统验证登录信息**：系统从users表中查询用户名，验证密码是否正确
5. **系统创建用户会话**：验证通过后，系统创建用户会话，保存用户信息
6. **系统记录登录日志**：系统在operation_logs表中记录用户的登录操作
7. **用户进入主界面**：系统将用户重定向到系统主界面

### 2.5 数据修改流程

**流程图**：
```
开始
  │
  ▼
用户登录系统
  │
  ▼
在侧边栏选择要操作的表格
  │
  ▼
系统加载表格数据
  │
  ▼
用户点击要修改的数据行的"编辑"按钮
  │
  ▼
系统根据表格结构和当前数据生成编辑表单
  │
  ▼
用户修改数据
  │
  ▼
提交修改
  │
  ▼
系统验证数据合法性
  │
  ├─失败─► 显示错误提示
  │       │
  │       ▼
  │       结束
  │
  └─成功─► 系统更新数据库中的数据
  │
  ▼
数据表格更新
  │
  ▼
系统记录操作日志
  │
  ▼
结束
```

**详细步骤**：
1. **用户登录系统**：用户输入用户名和密码，系统验证通过后进入系统主界面
2. **选择要操作的表格**：用户在侧边栏的已定义表格列表中选择要操作的表格
3. **系统加载表格数据**：系统从数据库中加载所选表格的库存数据
4. **用户点击"编辑"按钮**：用户点击要修改的数据行末尾的"编辑"按钮
5. **系统生成编辑表单**：系统根据表格结构和当前数据，动态生成编辑表单
6. **用户修改数据**：用户在编辑表单中修改相应的字段值
7. **提交修改**：用户点击"保存"按钮，提交修改后的表单
8. **系统验证数据合法性**：系统验证修改后的数据的完整性和合法性
9. **系统更新数据**：验证通过后，系统更新数据库中的库存数据
10. **数据表格更新**：系统更新数据显示区域的表格，显示修改后的数据
11. **系统记录操作日志**：系统在operation_logs表中记录用户的修改操作

### 2.6 数据删除流程

**流程图**：
```
开始
  │
  ▼
用户登录系统
  │
  ▼
在侧边栏选择要操作的表格
  │
  ▼
系统加载表格数据
  │
  ▼
用户点击要删除的数据行的"删除"按钮
  │
  ▼
系统显示确认对话框
  │
  ▼
用户确认删除
  │
  ├─取消─► 结束
  │
  └─确认─► 系统删除数据库中的数据
  │
  ▼
数据表格更新
  │
  ▼
系统记录操作日志
  │
  ▼
结束
```

**详细步骤**：
1. **用户登录系统**：用户输入用户名和密码，系统验证通过后进入系统主界面
2. **选择要操作的表格**：用户在侧边栏的已定义表格列表中选择要操作的表格
3. **系统加载表格数据**：系统从数据库中加载所选表格的库存数据
4. **用户点击"删除"按钮**：用户点击要删除的数据行末尾的"删除"按钮
5. **系统显示确认对话框**：系统弹出确认对话框，提示用户是否确定要删除该数据
6. **用户确认删除**：用户点击"确认"按钮，确认删除该数据
7. **系统删除数据**：系统从数据库中删除该库存数据
8. **数据表格更新**：系统更新数据显示区域的表格，移除已删除的数据
9. **系统记录操作日志**：系统在operation_logs表中记录用户的删除操作

## 3. 数据模型和业务流程的适配性

### 3.1 数据模型对业务流程的支持

1. **表格结构定义流程**：
   - TableStructures表支持存储表格名称和列定义
   - columns字段使用JSON格式存储，支持动态添加和修改列信息

2. **数据添加/修改/删除流程**：
   - InventoryData表支持存储不同表格的库存数据
   - data字段使用JSON格式存储，支持动态扩展字段
   - created_by字段记录数据创建者，支持权限控制

3. **数据查询流程**：
   - 表格结构和库存数据分离存储，支持灵活的查询和过滤
   - 可以根据表格ID查询特定表格的数据
   - 可以根据创建者ID查询特定用户创建的数据

4. **用户认证和权限控制流程**：
   - Users表存储用户信息和角色
   - role字段支持基于角色的权限控制
   - OperationLogs表记录用户操作，支持审计功能

### 3.2 业务流程对数据模型的影响

1. **动态表格结构**：
   - 业务流程要求支持自定义表格结构，因此数据模型使用JSON格式存储列定义和库存数据
   - 这种设计允许系统在运行时动态调整表格结构，无需修改数据库 schema

2. **权限控制**：
   - 业务流程要求不同角色有不同的权限，因此数据模型包含role字段和created_by字段
   - 这些字段支持基于角色和创建者的数据访问控制

3. **操作日志**：
   - 业务流程要求记录用户操作，因此数据模型包含operation_logs表
   - 该表记录用户的所有关键操作，支持审计和追溯

## 4. 数据模型和业务流程的优化建议

### 4.1 数据模型优化建议

1. **添加索引**：
   - 在Users表的username字段添加唯一索引，提高登录验证速度
   - 在TableStructures表的table_name字段添加索引，提高表格查询速度
   - 在InventoryData表的table_id和created_by字段添加索引，提高数据查询速度
   - 在OperationLogs表的user_id、table_id和data_id字段添加索引，提高日志查询速度

2. **优化JSON字段**：
   - 考虑使用更高效的JSON解析库，提高JSON数据的读写性能
   - 对频繁查询的JSON字段，可以考虑提取为单独的列，提高查询性能

3. **添加数据验证**：
   - 在应用层添加数据验证，确保JSON数据格式正确
   - 对关键字段添加约束，如非空约束、长度约束等

### 4.2 业务流程优化建议

1. **表格结构缓存**：
   - 对频繁访问的表格结构进行缓存，减少数据库查询次数
   - 当表格结构发生变化时，及时更新缓存

2. **数据分页**：
   - 对大量数据的查询结果进行分页处理，提高页面加载速度
   - 支持用户自定义每页显示的记录数

3. **批量操作**：
   - 支持批量添加、修改和删除数据，提高操作效率
   - 对批量操作进行事务管理，确保数据一致性

4. **异步处理**：
   - 对耗时的操作（如数据导入、报表生成等）采用异步处理，提高系统响应速度
   - 使用消息队列或任务调度系统处理异步任务

## 5. 总结

本系统的数据模型设计采用了灵活的JSON格式存储表格结构和库存数据，支持动态扩展和自定义表格结构。业务流程设计涵盖了表格结构定义、数据管理、用户认证等核心功能，流程清晰，易于实现。

数据模型和业务流程的设计充分考虑了系统的可扩展性和性能需求，能够满足实验室库存管理的实际需求。同时，通过添加索引、优化JSON字段、缓存等优化措施，可以进一步提高系统的性能和响应速度。